{% extends "inverso_sa/panel.html" %}
{% load static %}

{% block title %}Solicitudes de Recarga{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'inverso_sa/css/solicitudes_recarga.css' %}">
{% endblock %}

{% block page_title %}
üí∑ Solicitudes de Recarga
{% endblock %}

{% block content %}

<div class="table-container">
    <table class="recargas-table">
        <thead>
            <tr>
                <th>Usuario</th>
                <th>Correo</th>
                <th>Monto</th>
                <th>Referencia</th>
                <th>Estado</th>
                <th>Fecha</th>
                <th>Acci√≥n</th>
            </tr>
        </thead>

        <tbody>
            {% for recarga in recargas %}
            <tr>
                <td>{{ recarga.usuario.username }}</td>
                <td>{{ recarga.usuario.email }}</td>
                <td>C$ {{ recarga.monto }}</td>
                <td>{{ recarga.referencia }}</td>
                <td>
                    {% if recarga.estado == 'revision' %}
                        <span class="badge warning">üïí En revisi√≥n</span>
                    {% elif recarga.estado == 'aprobada' %}
                        <span class="badge success">‚úÖ Aprobada</span>
                    {% else %}
                        <span class="badge danger">‚ùå Rechazada</span>
                    {% endif %}
                </td>
                <td>{{ recarga.fecha|date:"d/m/Y H:i" }}</td>
                <td>
                    <button class="btn-sm edit"
                            onclick="openModal({{ recarga.id }})">
                        Ver
                    </button>
                </td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="7" style="text-align:center;">
                    No hay solicitudes de recarga
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- ================= MODALES ================= -->
{% for recarga in recargas %}
<div class="modal" id="modal-{{ recarga.id }}">
    <div class="modal-content">

        <div class="modal-header">
            <h3>Solicitud de Recarga</h3>
            <span class="close-modal"
                  onclick="closeModal({{ recarga.id }})">&times;</span>
        </div>

        <div class="modal-body">
            <p><strong>Usuario:</strong> {{ recarga.usuario.username }}</p>
            <p><strong>Correo:</strong> {{ recarga.usuario.email }}</p>
            <p><strong>Banco:</strong> {{ recarga.cuenta.banco }}</p>
            <p><strong>Destinatario:</strong> {{ recarga.cuenta.destinatario }}</p>
            <p><strong>N¬∞ Cuenta:</strong> {{ recarga.cuenta.numero_cuenta }}</p>
            <p><strong>Monto:</strong> C$ {{ recarga.monto }}</p>
            <p><strong>Referencia:</strong> {{ recarga.referencia }}</p>

            {% if recarga.voucher %}
                <img src="{{ recarga.voucher.url }}" class="voucher-img">
            {% endif %}
        </div>

        {% if recarga.estado == 'revision' %}
        <div class="modal-footer">
            <form method="POST"
                  action="{% url 'aprobar_rechazar_recarga' recarga.id %}">
                {% csrf_token %}
                <button class="btn-sm edit" name="accion" value="aprobar">
                    Aprobar
                </button>
                <button class="btn-sm delete" name="accion" value="rechazar">
                    Rechazar
                </button>
            </form>
        </div>
        {% endif %}

    </div>
</div>
{% endfor %}

<!-- ================= JS AQU√ç MISMO ================= -->
<script>
    function openModal(id) {
        const modal = document.getElementById("modal-" + id);
        if (modal) {
            modal.classList.add("show");
        }
    }

    function closeModal(id) {
        const modal = document.getElementById("modal-" + id);
        if (modal) {
            modal.classList.remove("show");
        }
    }

    window.addEventListener("click", function (e) {
        if (e.target.classList.contains("modal")) {
            e.target.classList.remove("show");
        }
    });
</script>

{% endblock %}
